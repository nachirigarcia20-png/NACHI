import requests
import pandas as pd

# >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
# 1. FILL THESE WITH YOUR RAPIDAPI INFO
# >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
RAPIDAPI_KEY = "YOUR_RAPIDAPI_KEY_HERE"  # from RapidAPI
RAPIDAPI_HOST = "api-american-football.p.rapidapi.com"  # as shown in RapidAPI
NFL_LEAGUE_ID = "1"      # check in RapidAPI docs which league id = NFL
SEASON = "2025"          # season you want
# <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<

def fetch_games():
    url = "https://api-american-football.p.rapidapi.com/games"
    headers = {
        "X-RapidAPI-Key": RAPIDAPI_KEY,
        "X-RapidAPI-Host": RAPIDAPI_HOST,
    }
    params = {
        "league": NFL_LEAGUE_ID,
        "season": SEASON,
        # you can add status="finished" if they support it, to only get completed games
    }

    r = requests.get(url, headers=headers, params=params, timeout=20)
    r.raise_for_status()
    data = r.json()

    # API-SPORTS style: main data usually in "response"
    games = data.get("response", data)
    return games

def build_model_edges_csv(output_path="model_edges_2025.csv"):
    games = fetch_games()
    rows = []

    for g in games:
        # The exact keys depend on the API structure. For API-SPORTS style, it's often:
        # g["week"], g["teams"]["home"]["code"], g["teams"]["away"]["code"], g["scores"]["home"]["total"]
        week = g.get("week") or g.get("week_name") or g.get("round")

        teams = g.get("teams", {})
        home_team_info = teams.get("home", {})
        away_team_info = teams.get("away", {})

        # Prefer a short code like "KC", fallback to full name if code missing
        home_team = home_team_info.get("code") or home_team_info.get("name")
        away_team = away_team_info.get("code") or away_team_info.get("name")

        # Scores (if provided by API)
        scores = g.get("scores", {})
        home_score = scores.get("home", {}).get("total")
        away_score = scores.get("away", {}).get("total")

        # For now we use dummy model values – you will plug your real model later
        model_home_win_prob = 0.50
        model_away_win_prob = 0.50
        edge_spread = 0.0
        edge_moneyline = 0.0

        rows.append({
            "week": week,
            "home_team": home_team,
            "away_team": away_team,
            "home_score": home_score,
            "away_score": away_score,
            "model_home_win_prob": model_home_win_prob,
            "model_away_win_prob": model_away_win_prob,
            "edge_spread": edge_spread,
            "edge_moneyline": edge_moneyline,
        })

    df = pd.DataFrame(rows)

    # Clean week column a bit
    try:
        # If week looks like "Week 1", turn it into 1, etc.
        df["week"] = df["week"].astype(str).str.extract(r"(\d+)").astype(int)
    except Exception:
        pass  # if it fails, we just keep whatever is there

    # Keep only the columns your Streamlit app needs
    final = df[[
        "week",
        "home_team",
        "away_team",
        "model_home_win_prob",
        "model_away_win_prob",
        "edge_spread",
        "edge_moneyline",
    ]].sort_values(["week", "home_team", "away_team"])

    final.to_csv(output_path, index=False)
    print(f"✅ Saved {len(final)} games to {output_path}")

if __name__ == "__main__":
    build_model_edges_csv()
